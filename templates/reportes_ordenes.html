{% extends "base.html" %}
{% block title %}Reporte: Órdenes con productos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="bi bi-card-checklist"></i> Órdenes con productos</h4>
  <div>
    <button id="btnHoy" class="btn btn-outline-primary btn-sm">Hoy</button>
    <button id="btnTodas" class="btn btn-outline-secondary btn-sm">Todas</button>
  </div>
</div>

<div class="card shadow-sm border-0">
  <div class="card-body">
    <div id="listado" class="row g-3"></div>
  </div>
</div>

<script>
  function getCookie(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  function fmtMoney(n){ return '$' + Number(n||0).toFixed(2); }

  async function fetchJSON(url){
    const r = await fetch(url, {headers: {'X-CSRFToken': csrftoken}});
    if(!r.ok) throw new Error('HTTP ' + r.status);
    return await r.json();
  }

  async function cargarOrdenes({soloHoy=false} = {}){
    const cont = document.getElementById('listado');
    cont.innerHTML = `
      <div class="col-12 text-center text-muted py-3">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        <span class="ms-2">Cargando órdenes…</span>
      </div>`;

    // 1) Traer órdenes (maestros)
    // Puedes filtrar por fecha desde el backend; aquí traemos y filtramos si se requiere
    const ordenes = await fetchJSON('/api/ordenes/');  // OrdenSerializer
    let data = Array.isArray(ordenes.results) ? ordenes.results : ordenes; // por si tienes paginación DRF

    if(soloHoy){
      const hoy = new Date().toISOString().slice(0,10);
      data = data.filter(o => (o.creado||'').slice(0,10) === hoy);
    }

    if(!data.length){
      cont.innerHTML = `<div class="col-12 text-center text-muted py-3">Sin órdenes</div>`;
      return;
    }

    // Render básico de tarjetas de orden
    cont.innerHTML = data.map(o => `
      <div class="col-md-6">
        <div class="border rounded-3 h-100 p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">Folio: ${o.folio ?? '—'}</div>
              <div class="small text-muted">${(o.creado || '').replace('T',' ').slice(0,19)}</div>
              <span class="badge bg-${badgeEstado(o.estado)} mt-1">${o.estado}</span>
            </div>
            <div class="text-end">
              <div class="small text-muted">Total</div>
              <div class="fs-6 fw-bold">${fmtMoney(o.total)}</div>
            </div>
          </div>
          <hr class="my-2"/>
          <div class="small text-muted mb-1">Productos</div>
          <ul class="list-unstyled mb-0" id="items-${o.id}">
            <li class="text-muted">Cargando items…</li>
          </ul>
        </div>
      </div>
    `).join('');

    //  Para cada orden, traer sus items
    for(const o of data){
      try{
        const items = await fetchJSON(`/api/ordenes/${o.id}/items/`);
        const ul = document.getElementById(`items-${o.id}`);
        ul.innerHTML = items.map(it => `
          <li class="d-flex justify-content-between align-items-center py-1">
            <span>${it.cantidad} × ${it.producto_nombre ?? it.producto?.nombre ?? 'Producto'}</span>
            <span class="fw-semibold">${fmtMoney(it.subtotal)}</span>
          </li>
        `).join('');
        if(!items.length){
          ul.innerHTML = `<li class="text-muted">Sin productos</li>`;
        }
      }catch(e){
        document.getElementById(`items-${o.id}`).innerHTML = `<li class="text-danger">Error al cargar items</li>`;
      }
    }
  }

  function badgeEstado(estado){
    switch(estado){
      case 'PENDIENTE_PAGO': return 'secondary';
      case 'PAGADA': return 'primary';
      case 'EN_COLA': return 'warning';
      case 'EN_PREPARACION': return 'info';
      case 'LISTA': return 'success';
      case 'ENTREGADA': return 'dark';
      default: return 'light';
    }
  }

  document.getElementById('btnHoy').addEventListener('click', ()=>cargarOrdenes({soloHoy:true}));
  document.getElementById('btnTodas').addEventListener('click', ()=>cargarOrdenes({soloHoy:false}));

  (async ()=>{ await cargarOrdenes({soloHoy:true}); })();
</script>
{% endblock %}
